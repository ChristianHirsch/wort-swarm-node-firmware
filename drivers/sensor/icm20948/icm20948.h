/*
 * SPDX-License-Identifier: Apache-2.0
 */


#ifndef ZEPHYR_DRIVERS_SENSOR_ICM_20498_H_
#define ZEPHYR_DRIVERS_SENSOR_ICM_20498_H_

#include <drivers/sensor.h>
#include <zephyr/types.h>
#include <device.h>
#include <drivers/gpio.h>

#ifdef CONFIG_ICM20948_I2C_AD0
	#define CONFIG_ICM20948_I2C_SLAVE_ADDR 0x69
#else
	#define CONFIG_ICM20948_I2C_SLAVE_ADDR 0x68
#endif


/* banks */
#define ICM20948_BANK_0 0
#define ICM20948_BANK_1 1
#define ICM20948_BANK_2 2
#define ICM20948_BANK_3 3

#define ICM20948_BANK_REG(BANK, REG) ((BANK << 7) | REG)
/* registers */
#define ICM20948_REG_BANK_SEL 0x7F

#define ICM20948_REG_WHO_AM_I                        ICM20948_BANK_REG(ICM20948_BANK_0, 0x00)
#define ICM20948_REG_LPF                             ICM20948_BANK_REG(ICM20948_BANK_0, 0x01)
#define ICM20948_REG_USER_CTRL                       ICM20948_BANK_REG(ICM20948_BANK_0, 0x03)
#define ICM20948_REG_LP_CONFIG                       ICM20948_BANK_REG(ICM20948_BANK_0, 0x05)
#define ICM20948_REG_PWR_MGMT_1                      ICM20948_BANK_REG(ICM20948_BANK_0, 0x06)
#define ICM20948_REG_PWR_MGMT_2                      ICM20948_BANK_REG(ICM20948_BANK_0, 0x07)
#define ICM20948_REG_INT_PIN_CFG                     ICM20948_BANK_REG(ICM20948_BANK_0, 0x0F)
#define ICM20948_REG_INT_ENABLE                      ICM20948_BANK_REG(ICM20948_BANK_0, 0x10)
#define ICM20948_REG_INT_ENABLE_1                    ICM20948_BANK_REG(ICM20948_BANK_0, 0x11)
#define ICM20948_REG_INT_ENABLE_2                    ICM20948_BANK_REG(ICM20948_BANK_0, 0x12)
#define ICM20948_REG_INT_ENABLE_3                    ICM20948_BANK_REG(ICM20948_BANK_0, 0x13)
#define ICM20948_REG_DMP_INT_STATUS                  ICM20948_BANK_REG(ICM20948_BANK_0, 0x18)
#define ICM20948_REG_INT_STATUS                      ICM20948_BANK_REG(ICM20948_BANK_0, 0x19)
#define ICM20948_REG_INT_STATUS_1                    ICM20948_BANK_REG(ICM20948_BANK_0, 0x1A)
#define ICM20948_REG_INT_STATUS_2                    ICM20948_BANK_REG(ICM20948_BANK_0, 0x1B)
#define ICM20948_REG_SINGLE_FIFO_PRIORITY_SEL        ICM20948_BANK_REG(ICM20948_BANK_0, 0x26)
#define ICM20948_REG_GYRO_XOUT_H_SH                  ICM20948_BANK_REG(ICM20948_BANK_0, 0x33)
#define ICM20948_REG_TEMPERATURE                     ICM20948_BANK_REG(ICM20948_BANK_0, 0x39)
#define ICM20948_REG_TEMP_CONFIG                     ICM20948_BANK_REG(ICM20948_BANK_0, 0x53)
#define ICM20948_REG_EXT_SLV_SENS_DATA_00            ICM20948_BANK_REG(ICM20948_BANK_0, 0x3B)
#define ICM20948_REG_EXT_SLV_SENS_DATA_08            ICM20948_BANK_REG(ICM20948_BANK_0, 0x43)
#define ICM20948_REG_EXT_SLV_SENS_DATA_09            ICM20948_BANK_REG(ICM20948_BANK_0, 0x44)
#define ICM20948_REG_EXT_SLV_SENS_DATA_10            ICM20948_BANK_REG(ICM20948_BANK_0, 0x45)
#define ICM20948_REG_FIFO_EN                         ICM20948_BANK_REG(ICM20948_BANK_0, 0x66)
#define ICM20948_REG_FIFO_EN_2                       ICM20948_BANK_REG(ICM20948_BANK_0, 0x67)
#define ICM20948_REG_FIFO_RST                        ICM20948_BANK_REG(ICM20948_BANK_0, 0x68)
#define ICM20948_REG_FIFO_COUNT_H                    ICM20948_BANK_REG(ICM20948_BANK_0, 0x70)
#define ICM20948_REG_FIFO_R_W                        ICM20948_BANK_REG(ICM20948_BANK_0, 0x72)
#define ICM20948_REG_HW_FIX_DISABLE                  ICM20948_BANK_REG(ICM20948_BANK_0, 0x75)
#define ICM20948_REG_FIFO_CFG                        ICM20948_BANK_REG(ICM20948_BANK_0, 0x76)
#define ICM20948_REG_ACCEL_XOUT_H_SH                 ICM20948_BANK_REG(ICM20948_BANK_0, 0x2D)
#define ICM20948_REG_ACCEL_XOUT_L_SH                 ICM20948_BANK_REG(ICM20948_BANK_0, 0x2E)
#define ICM20948_REG_ACCEL_YOUT_H_SH                 ICM20948_BANK_REG(ICM20948_BANK_0, 0x2F)
#define ICM20948_REG_ACCEL_YOUT_L_SH                 ICM20948_BANK_REG(ICM20948_BANK_0, 0x30)
#define ICM20948_REG_ACCEL_ZOUT_H_SH                 ICM20948_BANK_REG(ICM20948_BANK_0, 0x31)
#define ICM20948_REG_ACCEL_ZOUT_L_SH                 ICM20948_BANK_REG(ICM20948_BANK_0, 0x32)
#define ICM20948_REG_GYRO_XOUT_H_SH                  ICM20948_BANK_REG(ICM20948_BANK_0, 0x33)
#define ICM20948_REG_GYRO_XOUT_L_SH                  ICM20948_BANK_REG(ICM20948_BANK_0, 0x34)
#define ICM20948_REG_GYRO_YOUT_H_SH                  ICM20948_BANK_REG(ICM20948_BANK_0, 0x35)
#define ICM20948_REG_GYRO_YOUT_L_SH                  ICM20948_BANK_REG(ICM20948_BANK_0, 0x36)
#define ICM20948_REG_GYRO_ZOUT_H_SH                  ICM20948_BANK_REG(ICM20948_BANK_0, 0x37)
#define ICM20948_REG_GYRO_ZOUT_L_SH                  ICM20948_BANK_REG(ICM20948_BANK_0, 0x38)
#define ICM20948_REG_TEMP_OUT_H_SH                   ICM20948_BANK_REG(ICM20948_BANK_0, 0x39)
#define ICM20948_REG_TEMP_OUT_L_SH                   ICM20948_BANK_REG(ICM20948_BANK_0, 0x3A)
#define ICM20948_REG_MEM_START_ADDR                  ICM20948_BANK_REG(ICM20948_BANK_0, 0x7C)
#define ICM20948_REG_MEM_R_W                         ICM20948_BANK_REG(ICM20948_BANK_0, 0x7D)
#define ICM20948_REG_MEM_BANK_SEL                    ICM20948_BANK_REG(ICM20948_BANK_0, 0x7E)
#define ICM20948_REG_XA_OFFS_H                       ICM20948_BANK_REG(ICM20948_BANK_1, 0x14)
#define ICM20948_REG_YA_OFFS_H                       ICM20948_BANK_REG(ICM20948_BANK_1, 0x17)
#define ICM20948_REG_ZA_OFFS_H                       ICM20948_BANK_REG(ICM20948_BANK_1, 0x1A)
#define ICM20948_REG_TIMEBASE_CORRECTION_PLL         ICM20948_BANK_REG(ICM20948_BANK_1, 0x28)
#define ICM20948_REG_TIMEBASE_CORRECTION_RCOSC       ICM20948_BANK_REG(ICM20948_BANK_1, 0x29)
#define ICM20948_REG_SELF_TEST1                      ICM20948_BANK_REG(ICM20948_BANK_1, 0x02)
#define ICM20948_REG_SELF_TEST2                      ICM20948_BANK_REG(ICM20948_BANK_1, 0x03)
#define ICM20948_REG_SELF_TEST3                      ICM20948_BANK_REG(ICM20948_BANK_1, 0x04)
#define ICM20948_REG_SELF_TEST4                      ICM20948_BANK_REG(ICM20948_BANK_1, 0x0E)
#define ICM20948_REG_SELF_TEST5                      ICM20948_BANK_REG(ICM20948_BANK_1, 0x0F)
#define ICM20948_REG_SELF_TEST6                      ICM20948_BANK_REG(ICM20948_BANK_1, 0x10)
#define ICM20948_REG_GYRO_SMPLRT_DIV                 ICM20948_BANK_REG(ICM20948_BANK_2, 0x00)
#define ICM20948_REG_GYRO_CONFIG_1                   ICM20948_BANK_REG(ICM20948_BANK_2, 0x01)
#define ICM20948_REG_GYRO_CONFIG_2                   ICM20948_BANK_REG(ICM20948_BANK_2, 0x02)
#define ICM20948_REG_XG_OFFS_USR_H                   ICM20948_BANK_REG(ICM20948_BANK_2, 0x03)
#define ICM20948_REG_YG_OFFS_USR_H                   ICM20948_BANK_REG(ICM20948_BANK_2, 0x05)
#define ICM20948_REG_ZG_OFFS_USR_H                   ICM20948_BANK_REG(ICM20948_BANK_2, 0x07)
#define ICM20948_REG_ACCEL_SMPLRT_DIV_1              ICM20948_BANK_REG(ICM20948_BANK_2, 0x10)
#define ICM20948_REG_ACCEL_SMPLRT_DIV_2              ICM20948_BANK_REG(ICM20948_BANK_2, 0x11)
#define ICM20948_REG_ACCEL_CONFIG                    ICM20948_BANK_REG(ICM20948_BANK_2, 0x14)
#define ICM20948_REG_ACCEL_CONFIG_2                  ICM20948_BANK_REG(ICM20948_BANK_2, 0x15)
#define ICM20948_REG_PRS_ODR_CONFIG                  ICM20948_BANK_REG(ICM20948_BANK_2, 0x20)
#define ICM20948_REG_PRGM_START_ADDRH                ICM20948_BANK_REG(ICM20948_BANK_2, 0x50)
#define ICM20948_REG_MOD_CTRL_USR                    ICM20948_BANK_REG(ICM20948_BANK_2, 0x54)
#define ICM20948_REG_I2C_MST_ODR_CONFIG              ICM20948_BANK_REG(ICM20948_BANK_3, 0x0)
#define ICM20948_REG_I2C_MST_CTRL                    ICM20948_BANK_REG(ICM20948_BANK_3, 0x01)
#define ICM20948_REG_I2C_MST_DELAY_CTRL              ICM20948_BANK_REG(ICM20948_BANK_3, 0x02)
#define ICM20948_REG_I2C_SLV0_ADDR                   ICM20948_BANK_REG(ICM20948_BANK_3, 0x03)
#define ICM20948_REG_I2C_SLV0_REG                    ICM20948_BANK_REG(ICM20948_BANK_3, 0x04)
#define ICM20948_REG_I2C_SLV0_CTRL                   ICM20948_BANK_REG(ICM20948_BANK_3, 0x05)
#define ICM20948_REG_I2C_SLV0_DO                     ICM20948_BANK_REG(ICM20948_BANK_3, 0x06)
#define ICM20948_REG_I2C_SLV1_ADDR                   ICM20948_BANK_REG(ICM20948_BANK_3, 0x07)
#define ICM20948_REG_I2C_SLV1_REG                    ICM20948_BANK_REG(ICM20948_BANK_3, 0x08)
#define ICM20948_REG_I2C_SLV1_CTRL                   ICM20948_BANK_REG(ICM20948_BANK_3, 0x09)
#define ICM20948_REG_I2C_SLV1_DO                     ICM20948_BANK_REG(ICM20948_BANK_3, 0x0A)
#define ICM20948_REG_I2C_SLV2_ADDR                   ICM20948_BANK_REG(ICM20948_BANK_3, 0x0B)
#define ICM20948_REG_I2C_SLV2_REG                    ICM20948_BANK_REG(ICM20948_BANK_3, 0x0C)
#define ICM20948_REG_I2C_SLV2_CTRL                   ICM20948_BANK_REG(ICM20948_BANK_3, 0x0D)
#define ICM20948_REG_I2C_SLV2_DO                     ICM20948_BANK_REG(ICM20948_BANK_3, 0x0E)
#define ICM20948_REG_I2C_SLV3_ADDR                   ICM20948_BANK_REG(ICM20948_BANK_3, 0x0F)
#define ICM20948_REG_I2C_SLV3_REG                    ICM20948_BANK_REG(ICM20948_BANK_3, 0x10)
#define ICM20948_REG_I2C_SLV3_CTRL                   ICM20948_BANK_REG(ICM20948_BANK_3, 0x11)
#define ICM20948_REG_I2C_SLV3_DO                     ICM20948_BANK_REG(ICM20948_BANK_3, 0x12)
#define ICM20948_REG_I2C_SLV4_CTRL                   ICM20948_BANK_REG(ICM20948_BANK_3, 0x15)

#define ICM20948_WHO_AM_I 0xEA

#define ICM20948_ACCEL_MASK (BIT(1) | BIT(2))
enum icm20948_accel_fs {
	ICM20948_ACCEL_2G_VAL = 0,
	ICM20948_ACCEL_FS_4G_VAL,
	ICM20948_ACCEL_FS_8G_VAL,
	ICM20948_ACCEL_FS_16G_VAL
};

enum icm20948_int_fs {
	ICM20948_INT_I2C_MST_INT_EN = BIT(0),
	ICM20948_INT_DMP_INT1_EN = BIT(1),
	ICM20948_INT_PLL_RDY_EN = BIT(2),
	ICM20948_INT_WOM_INT_EN = BIT(3),
	ICM20948_INT_REG_WOF_EN = BIT(7)
};

#define ICM20948_ACCEL_FS_DEFAULT ICM20948_ACCEL_2G_VAL
#if defined(CONFIG_ICM20948_ACCEL_RANGE_4G)
#define ICM20948_ACCEL_FS_DEFAULT ICM20948_ACCEL_FS_4G_VAL
#elif defined(CONFIG_ICM20948_ACCEL_RANGE_8G)
#define ICM20948_ACCEL_FS_DEFAULT ICM20948_ACCEL_FS_8G_VAL
#elif defined(CONFIG_ICM20948_ACCEL_RANGE_16G)
#define ICM20948_ACCEL_FS_DEFAULT ICM20948_ACCEL_FS_16G_VAL
#endif

#define ICM20948_GYRO_MASK (BIT(1) | BIT(2))
enum icm20948_gyro_fs {
	ICM20948_GYRO_FS_250_VAL = 0,
	ICM20948_GYRO_FS_500_VAL,
	ICM20948_GYRO_FS_1000_VAL,
	ICM20948_GYRO_FS_2000_VAL
};

#define ICM20948_GYRO_FS_DEFAULT ICM20948_GYRO_FS_250_VAL
#if defined(CONFIG_ICM20948_ACCEL_RANGE_4G)
#define ICM20948_GYRO_FS_DEFAULT ICM20948_GYRO_FS_500_VAL
#elif defined(CONFIG_ICM20948_ACCEL_RANGE_8G)
#define ICM20948_GYRO_FS_DEFAULT ICM20948_GYRO_FS_1000_VAL
#elif defined(CONFIG_ICM20948_ACCEL_RANGE_16G)
#define ICM20948_GYRO_FS_DEFAULT ICM20948_GYRO_FS_2000_VAL
#endif

#define ICM20948_ENABLE_FSYNC 0
#if defined(CONFIG_ICM20948_ENABLE_WAKE_FSYNC)
	#define ICM20948_ENABLE_FSYNC BIT(7)
#endif


/* sensor data forward declaration (member definition is below) */
struct icm20948_data;

struct icm20948_tf {
	int (*read_data)(struct icm20948_data *data, u16_t reg_bank_addr,
			 u8_t *value, u8_t len);

	int (*write_data)(struct icm20948_data *data, u16_t reg_bank_addr,
			  u8_t *value, u8_t len);

	int (*read_reg)(struct icm20948_data *data, u16_t reg_bank_addr,
			u8_t *value);

	int (*write_reg)(struct icm20948_data *data, u16_t reg_bank_addr,
			 u8_t value);

	int (*update_reg)(struct icm20948_data *data, u16_t reg_bank_addr,
			  u8_t mask, u8_t value);
};

struct icm20948_data {
	struct device *bus;
	const struct icm20948_tf *hw_tf;

	s16_t acc[3];
	s16_t gyro[3];

	s16_t temp;

	enum icm20948_gyro_fs gyro_fs;          // gyro range
	enum icm20948_accel_fs accel_fs;        // accel range

#if defined(DT_TDK_ICM20948_0_CS_GPIO_CONTROLLER)
	struct spi_cs_control cs_ctrl;
#endif
	u8_t bank; /* selected bank for sensor bank */
};

int icm20948_i2c_init(struct device *dev);
int icm20948_spi_init(struct device *dev);

int icm20948_set_interrupt(struct device *dev, uint8_t value);

#endif /* ZEPHYR_DRIVERS_SENSOR_BME280_BME280_H_ */
